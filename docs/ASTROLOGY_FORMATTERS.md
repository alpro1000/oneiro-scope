# Форматтеры натальной карты

Документ описывает два модуля форматирования в `backend/services/astrology` и фиксирует различия, чтобы избежать путаницы и повторного изобретения логики.

## `formatter.py` — типизированный форматтер для сервисного слоя
- **Входные данные:** объекты `PlanetPosition`, `House`, `Aspect` из схем домена Swiss Ephemeris.
- **Выход:** Markdown или JSON со структурой "планеты → аспекты → асцендент".
- **Локализация:** RU/EN, переключение через `language`.
- **Стиль описаний:** `scientific` (фактологично) или `poetic` (смягченные формулировки) — влияет на описание аспектов и ключевые слова.
- **Особенности:**
  - Конвертация названий/символов через словари (`PLANET_SYMBOLS`, `ASPECT_SYMBOLS`, `SIGN_PREPOSITIONAL_RU`).
  - Генерация заголовков и описаний планет с учётом ретроградности и элемента/качества знака.
  - Поддержка асцендента (1-й дом) как отдельного блока.

## `natal_formatter.py` — лёгкий хелпер для JSON/CLI
- **Входные данные:** простой `dict` (например, от CLI или облегчённого API), без зависимостей от доменных классов.
- **Выход:** Markdown или строка JSON с блоками "identity → core → planets → aspects".
- **Локализация:** RU/EN, переключение через `locale`.
- **Особенности:**
  - Акцент на быстрый рендер базовых позиций (Солнце, Луна, Асцендент) плюс произвольные планеты из словаря.
  - Минимальная обработка даты (`YYYY-MM-DD`) и отображение домов, если они переданы.
  - Описание аспектов без типов из схем — на основании строковых ключей и эмодзи.

## Итоги проверки на задвоения
- Модули **не дублируют бизнес-логику**: первый работает с доменными моделями сервиса, второй — с сырыми словарями.
- Пересечения ограничиваются справочными словарями (названия планет/знаков и символы). Они оставлены локально, потому что формат теряется при приведении типов, и каждый модуль оптимизирован под свой уровень абстракции.
- Для новых сценариев: используйте `ChartFormatter` в коде FastAPI/сервисов, а `format_natal_chart` — для утилит, CLI или когда нет датаклассов `schemas`.

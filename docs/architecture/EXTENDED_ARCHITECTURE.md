# OneiroScope Extended — Комплексный эзотерический сервис

## Обзор

Расширение OneiroScope до комплексной платформы с двумя основными направлениями:
1. **Астрология** — натальные карты, персональные гороскопы, прогнозы событий
2. **Анализ снов** — научный подход с университетскими базами данных

---

## 1. Новая структура сервисов

```
┌────────────────────────────────────────────────────────────────────────┐
│                    OneiroScope Extended Platform                        │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                      СТАРТОВАЯ СТРАНИЦА                         │   │
│  │                                                                  │   │
│  │    ┌──────────────┐              ┌──────────────┐              │   │
│  │    │     🌙       │              │     ⭐       │              │   │
│  │    │   АНАЛИЗ     │              │  АСТРОЛОГИЯ  │              │   │
│  │    │    СНОВ      │              │  & ПРОГНОЗЫ  │              │   │
│  │    │              │              │              │              │   │
│  │    │ - Толкование │              │ - Натальная  │              │   │
│  │    │ - Дневник    │              │   карта      │              │   │
│  │    │ - Паттерны   │              │ - Гороскоп   │              │   │
│  │    │              │              │ - Прогноз    │              │   │
│  │    │              │              │   событий    │              │   │
│  │    └──────────────┘              └──────────────┘              │   │
│  │                                                                  │   │
│  │    ┌────────────────────────────────────────────┐              │   │
│  │    │           🎤 ГОЛОСОВОЙ ВВОД                │              │   │
│  │    │  Запишите сон или опишите ситуацию голосом │              │   │
│  │    └────────────────────────────────────────────┘              │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│                         ▼                    ▼                          │
│                                                                         │
│  ┌─────────────────────────┐    ┌─────────────────────────┐           │
│  │    DREAM SERVICE        │    │   ASTROLOGY SERVICE     │           │
│  │                         │    │                          │           │
│  │  • Hall/Van de Castle   │    │  • Swiss Ephemeris       │           │
│  │  • DreamBank            │    │  • NASA JPL Horizons     │           │
│  │  • SDDb (Zenodo)        │    │  • Натальные расчеты     │           │
│  │  • LLM анализ           │    │  • Транзиты & аспекты    │           │
│  │  • Lunar correlation    │    │  • Вероятность событий   │           │
│  └─────────────────────────┘    └─────────────────────────┘           │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                     SHARED SERVICES                              │   │
│  │                                                                  │   │
│  │  • ASR Service (голосовой ввод)                                 │   │
│  │  • User Management & Auth                                        │   │
│  │  • Billing (Stripe/YooKassa)                                    │   │
│  │  • Lunar Calendar                                                │   │
│  │  • LLM Router (OpenAI/Anthropic/Together)                       │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────────────────────────┘
```

---

## 2. Модуль астрологии (НОВЫЙ)

### 2.1 Функциональность

#### Натальная карта
```yaml
Входные данные:
  - Дата рождения (обязательно)
  - Время рождения (желательно, иначе 12:00)
  - Место рождения (для определения координат)

Расчеты:
  - Позиции планет (Солнце, Луна, Меркурий...Плутон)
  - Асцендент (ASC) - восходящий знак
  - Средина неба (MC)
  - 12 домов (Плацидус/Кох)
  - Аспекты между планетами
  - Стихии и кресты

Вывод:
  - Визуализация карты (SVG/Canvas)
  - Текстовая интерпретация
  - Сильные/слабые стороны
  - Кармические узлы
```

#### Персональный гороскоп
```yaml
Типы:
  - Ежедневный (на основе транзитов)
  - Еженедельный (основные аспекты)
  - Месячный (ключевые периоды)
  - Годовой (Solar Return)

Методология:
  - Транзиты планет к натальной карте
  - Прогрессии (secondary progressions)
  - Солнечные возвращения (Solar Return)
```

#### Прогноз событий
```yaml
Входные данные:
  - Натальная карта пользователя
  - Дата события (или диапазон дат)
  - Тип события (переезд, свадьба, сделка, поездка, собеседование)
  - Место события (опционально)

Расчеты:
  - Транзиты на дату события
  - Аспекты к натальным планетам
  - Лунные фазы
  - Ретроградные планеты
  - Затмения в период

Вывод:
  - Оценка благоприятности (0-100%)
  - Положительные факторы
  - Риски и предостережения
  - Рекомендации по времени
  - Альтернативные даты (если неблагоприятно)
```

### 2.2 Научная база

```yaml
Источники данных:
  - Swiss Ephemeris (точные эфемериды планет)
    URL: https://www.astro.com/swisseph/
    Точность: < 1 угловой секунды

  - NASA JPL Horizons
    URL: https://ssd.jpl.nasa.gov/horizons/
    Данные: позиции тел Солнечной системы

  - USNO (Военно-морская обсерватория США)
    URL: https://aa.usno.navy.mil/
    Данные: лунные фазы, затмения

Научный подход:
  - Астрономически точные расчеты
  - Статистический анализ исторических данных
  - Явное разделение: факты (позиции) vs интерпретации
  - Дисклеймер об отсутствии научного доказательства астрологии
```

### 2.3 Техническая реализация

```python
# backend/services/astrology/

astrology/
├── __init__.py
├── service.py              # Основной оркестратор
├── ephemeris.py            # Интеграция Swiss Ephemeris
├── natal_chart.py          # Расчет натальной карты
├── transits.py             # Расчет транзитов
├── aspects.py              # Вычисление аспектов
├── houses.py               # Системы домов (Плацидус, Кох, и т.д.)
├── interpreter.py          # LLM-интерпретация
├── probability.py          # Расчет вероятности событий
├── geocoder.py             # Геокодинг места рождения
└── schemas.py              # Pydantic модели
```

```yaml
Python Libraries:
  - swisseph (pyswisseph) - эфемериды
  - geopy - геокодинг
  - timezonefinder - определение часового пояса
  - pytz - работа с временными зонами
```

### 2.4 API Endpoints

```yaml
Endpoints:

POST /api/v1/astrology/natal-chart:
  Input:
    birth_date: "1990-05-15"
    birth_time: "14:30"  # optional
    birth_place: "Moscow, Russia"
  Output:
    planets: [...]
    houses: [...]
    aspects: [...]
    interpretation: "..."

GET /api/v1/astrology/horoscope/{user_id}:
  Query params:
    period: "daily" | "weekly" | "monthly" | "yearly"
    date: "2024-12-06"
  Output:
    period: "daily"
    transits: [...]
    summary: "..."
    recommendations: [...]

POST /api/v1/astrology/event-forecast:
  Input:
    user_id: "uuid"
    event_date: "2024-12-25"
    event_type: "travel"
    event_location: "Paris, France"  # optional
  Output:
    favorability_score: 75
    positive_factors: [...]
    risks: [...]
    recommendations: [...]
    alternative_dates: ["2024-12-27", "2024-12-28"]
```

---

## 3. Расширенный модуль анализа снов

### 3.1 Научные базы данных

```yaml
Источники:

DreamBank (Университет Калифорнии, Санта-Круз):
  URL: https://dreambank.net
  Содержимое: 20,000+ снов с кодированием по Hall/Van de Castle
  Использование: нормы, статистика, сравнение

SDDb - Sleep and Dream Database (Zenodo):
  DOI: 10.5281/zenodo.XXXXXXX
  Содержимое: академические исследования сновидений
  Использование: паттерны, архетипы

UCI Dream Dataset:
  URL: UCI Machine Learning Repository
  Содержимое: размеченные сны для ML

Литература:
  - Jung, C.G. - архетипы
  - Hall, C.S. & Van de Castle, R.L. - система кодирования
  - Domhoff, G.W. - количественный анализ
```

### 3.2 Hall/Van de Castle кодирование

```yaml
Категории:

Characters (персонажи):
  - Мужчины/Женщины
  - Знакомые/Незнакомцы
  - Животные
  - Мифические существа

Social Interactions:
  - Агрессия (физическая/вербальная)
  - Дружелюбие
  - Сексуальность

Activities:
  - Физические действия
  - Движение/Перемещение
  - Вербальная активность

Emotions:
  - Страх/Тревога
  - Радость/Счастье
  - Гнев
  - Грусть
  - Смущение

Settings:
  - Знакомые места
  - Незнакомые места
  - Внутри/Снаружи

Success/Failure:
  - Удача/Неудача
  - Фортуна/Несчастье
```

### 3.3 Интеграция с лунным календарем

```yaml
Lunar-Dream Correlation:

Лунные дни и сны:
  1-7: Начало цикла, семенные сны
  8-14: Рост, развитие темы
  15: Полнолуние - яркие, пророческие сны
  16-22: Осмысление, интеграция
  23-29/30: Завершение, очистка

Фазы Луны:
  Новолуние: новые начинания в снах
  Растущая: развитие сюжетов
  Полнолуние: кульминация, яркость
  Убывающая: разрешение, отпускание
```

---

## 4. Голосовой ввод

### 4.1 Архитектура

```
┌──────────────────────────────────────────────────────────────────┐
│                     VOICE INPUT SYSTEM                            │
│                                                                   │
│  ┌─────────────────┐    ┌─────────────────┐    ┌──────────────┐ │
│  │   Browser       │    │   ASR Service   │    │   Text       │ │
│  │   Microphone    │───▶│                 │───▶│   Processing │ │
│  │                 │    │  • Web Speech   │    │              │ │
│  │  - MediaRecorder│    │  • Whisper API  │    │  • Language  │ │
│  │  - WebRTC       │    │  • Vosk offline │    │    detection │ │
│  └─────────────────┘    └─────────────────┘    └──────────────┘ │
│                                                                   │
│  Supported Scenarios:                                             │
│  • "Запиши мой сон" → Dream analysis                             │
│  • "Расскажу ситуацию" → Event forecast                          │
│  • "Какой сегодня лунный день" → Lunar info                      │
│  • "Мой гороскоп на сегодня" → Daily horoscope                   │
└──────────────────────────────────────────────────────────────────┘
```

### 4.2 Реализация

```typescript
// frontend/components/VoiceInput.tsx

interface VoiceInputProps {
  onTranscript: (text: string) => void;
  language: 'ru' | 'en';
  mode: 'dream' | 'astrology' | 'general';
}

// Стратегия:
// 1. Web Speech API (браузерный, бесплатный) - первый выбор
// 2. OpenAI Whisper API - fallback для сложных случаев
// 3. Vosk (offline) - для Telegram bot
```

### 4.3 API Endpoints

```yaml
POST /api/v1/asr/transcribe:
  Input:
    audio: binary (webm/ogg/mp3)
    language: "ru" | "en" | "auto"
    context: "dream" | "astrology"  # улучшает распознавание
  Output:
    text: "Мне снилось..."
    language_detected: "ru"
    confidence: 0.95
    duration_ms: 15000
```

---

## 5. Адаптивный дизайн

### 5.1 Breakpoints

```css
/* Мобильный телефон */
@media (max-width: 639px) {
  /* Одноколоночный layout */
  /* Большие кнопки для тапа (min 44x44px) */
  /* Упрощенная навигация (bottom bar) */
}

/* Планшет */
@media (min-width: 640px) and (max-width: 1023px) {
  /* Двухколоночный layout */
  /* Sidebar navigation */
  /* Увеличенные touch targets */
}

/* Десктоп */
@media (min-width: 1024px) {
  /* Полный layout */
  /* Hover states */
  /* Keyboard navigation */
}
```

### 5.2 Mobile-first компоненты

```yaml
Стартовая страница (Mobile):
  ┌─────────────────────────┐
  │        ☽ OneiroScope    │ <- Header (fixed)
  ├─────────────────────────┤
  │                         │
  │    ┌─────────────────┐  │
  │    │      🌙         │  │
  │    │   АНАЛИЗ СНОВ   │  │ <- Большие карточки
  │    │                 │  │
  │    └─────────────────┘  │
  │                         │
  │    ┌─────────────────┐  │
  │    │      ⭐         │  │
  │    │   АСТРОЛОГИЯ    │  │
  │    │                 │  │
  │    └─────────────────┘  │
  │                         │
  │    ┌─────────────────┐  │
  │    │  🎤 Голосовой   │  │ <- Кнопка голосового ввода
  │    │     ввод        │  │
  │    └─────────────────┘  │
  │                         │
  ├─────────────────────────┤
  │  🏠    🌙    ⭐    👤   │ <- Bottom navigation
  └─────────────────────────┘

Стартовая страница (Tablet/Desktop):
  ┌─────────────────────────────────────────────────┐
  │  ☽ OneiroScope         [EN|RU]    👤 Profile   │
  ├─────────────────────────────────────────────────┤
  │                                                  │
  │   ┌───────────────────┐  ┌───────────────────┐  │
  │   │                   │  │                   │  │
  │   │      🌙           │  │       ⭐          │  │
  │   │   АНАЛИЗ СНОВ     │  │   АСТРОЛОГИЯ      │  │
  │   │                   │  │                   │  │
  │   │  Расшифруйте свои │  │  Натальная карта  │  │
  │   │  сновидения по    │  │  и прогнозы на    │  │
  │   │  научной методике │  │  научной основе   │  │
  │   │                   │  │                   │  │
  │   │   [Начать →]      │  │   [Начать →]      │  │
  │   └───────────────────┘  └───────────────────┘  │
  │                                                  │
  │   ┌─────────────────────────────────────────┐   │
  │   │  🎤 Голосовой ввод                      │   │
  │   │  Нажмите и расскажите свой сон или     │   │
  │   │  опишите ситуацию для прогноза          │   │
  │   └─────────────────────────────────────────┘   │
  │                                                  │
  │   ┌─────────────────────────────────────────┐   │
  │   │  📅 Лунный календарь: День 15, Полнолуние │ │
  │   └─────────────────────────────────────────┘   │
  │                                                  │
  └─────────────────────────────────────────────────┘
```

---

## 6. База данных (расширение)

### 6.1 Новые таблицы

```sql
-- Натальные карты пользователей
CREATE TABLE natal_charts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    birth_date DATE NOT NULL,
    birth_time TIME,  -- NULL если неизвестно
    birth_place VARCHAR(255) NOT NULL,
    latitude DECIMAL(9,6),
    longitude DECIMAL(9,6),
    timezone VARCHAR(50),
    planets_data JSONB NOT NULL,  -- позиции планет
    houses_data JSONB NOT NULL,   -- дома
    aspects_data JSONB,           -- аспекты
    interpretation TEXT,           -- LLM интерпретация
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- Прогнозы событий
CREATE TABLE event_forecasts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    natal_chart_id UUID REFERENCES natal_charts(id),
    event_date DATE NOT NULL,
    event_type VARCHAR(50),  -- travel, wedding, business, etc.
    event_location VARCHAR(255),
    event_latitude DECIMAL(9,6),
    event_longitude DECIMAL(9,6),
    transits_data JSONB,
    favorability_score INTEGER,  -- 0-100
    positive_factors JSONB,
    risks JSONB,
    recommendations TEXT,
    alternative_dates DATE[],
    created_at TIMESTAMP DEFAULT NOW()
);

-- Гороскопы (кэширование)
CREATE TABLE horoscopes (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    natal_chart_id UUID REFERENCES natal_charts(id),
    period_type VARCHAR(20) NOT NULL,  -- daily, weekly, monthly, yearly
    period_start DATE NOT NULL,
    period_end DATE NOT NULL,
    transits_data JSONB,
    interpretation TEXT NOT NULL,
    recommendations JSONB,
    created_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(user_id, period_type, period_start)
);

-- Расширение таблицы users
ALTER TABLE users ADD COLUMN
    has_natal_chart BOOLEAN DEFAULT FALSE,
    preferred_service VARCHAR(20) DEFAULT 'dreams';  -- 'dreams', 'astrology', 'both'
```

---

## 7. LLM промпты

### 7.1 Анализ натальной карты

```yaml
System Prompt:
  "Вы профессиональный астролог с академическим подходом.
   Интерпретируйте натальную карту, основываясь на астрономических данных.
   Используйте научную терминологию, но объясняйте доступно.

   ВАЖНО:
   - Не делайте точных предсказаний будущего
   - Описывайте тенденции и потенциалы
   - Упоминайте, что астрология — это символическая система
   - Давайте практические рекомендации"

User Prompt Template:
  "Проанализируй натальную карту:

   Дата рождения: {birth_date}
   Время: {birth_time}
   Место: {birth_place}

   Планеты:
   {planets_json}

   Дома:
   {houses_json}

   Аспекты:
   {aspects_json}

   Дай интерпретацию по следующим разделам:
   1. Общая характеристика личности
   2. Эмоциональная сфера
   3. Интеллект и коммуникация
   4. Отношения
   5. Карьера и призвание
   6. Сильные стороны
   7. Зоны роста
   8. Рекомендации"
```

### 7.2 Прогноз события

```yaml
System Prompt:
  "Вы астролог-консультант. Анализируете транзиты планет
   относительно натальной карты для оценки благоприятности даты.

   Научный подход:
   - Используйте точные астрономические данные
   - Укажите конкретные аспекты и их значения
   - Дайте вероятностную оценку (не гарантии)
   - Предложите альтернативы если дата неблагоприятна"

User Prompt Template:
  "Оцени благоприятность даты для события:

   Тип события: {event_type}
   Дата: {event_date}
   Место: {event_location}

   Натальная карта клиента:
   {natal_chart_summary}

   Транзиты на дату события:
   {transits_json}

   Лунная фаза: {lunar_phase}
   Ретроградные планеты: {retrogrades}

   Оцени:
   1. Общую благоприятность (0-100%)
   2. Положительные аспекты
   3. Потенциальные сложности
   4. Рекомендации
   5. Альтернативные даты (±7 дней) если оценка < 50%"
```

---

## 8. План реализации

### Фаза 1: Основа (2-3 недели)
```
[ ] Создать стартовую страницу с выбором сервиса
[ ] Добавить маршруты /dreams и /astrology
[ ] Реализовать адаптивный дизайн (mobile-first)
[ ] Интегрировать Web Speech API для голосового ввода
[ ] Создать базовую структуру backend/services/astrology/
```

### Фаза 2: Астрология MVP (3-4 недели)
```
[ ] Интегрировать Swiss Ephemeris (pyswisseph)
[ ] Реализовать расчет натальной карты
[ ] Создать UI для ввода данных рождения
[ ] Реализовать визуализацию карты (SVG)
[ ] Интегрировать LLM для интерпретации
[ ] Добавить endpoint /api/v1/astrology/natal-chart
```

### Фаза 3: Прогнозы и гороскопы (2-3 недели)
```
[ ] Реализовать расчет транзитов
[ ] Создать endpoint для прогноза событий
[ ] Реализовать генерацию гороскопов (daily/weekly/monthly)
[ ] Добавить UI для выбора даты события
[ ] Интегрировать вероятностную оценку
```

### Фаза 4: Расширение анализа снов (2 недели)
```
[ ] Интегрировать DreamBank данные
[ ] Реализовать Hall/Van de Castle кодирование
[ ] Улучшить корреляцию с лунным календарем
[ ] Добавить статистику паттернов
```

### Фаза 5: Полировка (1-2 недели)
```
[ ] E2E тестирование
[ ] Оптимизация производительности
[ ] A/B тестирование UI
[ ] Документация для пользователей
```

---

## 9. Технические требования

### 9.1 Новые зависимости

```yaml
Backend (requirements.txt):
  - pyswisseph>=2.10.0    # Swiss Ephemeris
  - geopy>=2.4.0          # Геокодинг
  - timezonefinder>=6.2.0 # Определение TZ
  - numpy>=1.26.0         # Расчеты

Frontend (package.json):
  - @react-three/fiber    # 3D визуализация карты (опционально)
  - d3                    # SVG графики
  - react-speech-recognition # Web Speech API wrapper
```

### 9.2 Внешние API

```yaml
Geocoding:
  - OpenStreetMap Nominatim (бесплатно, rate limited)
  - Google Geocoding API (платно, точнее)

Ephemeris:
  - Swiss Ephemeris files (локальные, бесплатно)
  - Astro.com API (опционально)
```

---

## 10. Дисклеймеры

```markdown
Для астрологического раздела:

"Астрологические прогнозы основаны на астрономических расчетах
положений небесных тел. Интерпретации носят символический характер
и не являются научно доказанными. Используйте информацию как один
из инструментов самопознания, но принимайте решения самостоятельно."

Для анализа снов:

"Анализ снов основан на методике Hall/Van de Castle и данных
академических исследований. Интерпретации не являются медицинским
диагнозом. При постоянных проблемах со сном обратитесь к специалисту."
```

---

**Document Version**: 1.0
**Status**: Draft
**Created**: 2024-12-06

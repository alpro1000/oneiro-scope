# Лунный календарь и timezone: почему это важно

## Проблема: "Два 27-х дня"

Пользователь заметил, что в календаре появляются два 27-х лунных дня:
- 17 декабря 2025 → День 27
- 18 декабря 2025 → День 27

При этом сторонние источники (например, lunar-calendar.ru) показывают:
- 17 декабря → День 26
- 18 декабря → День 27

**Почему так происходит?**

---

## Как вычисляется лунный день

Лунный день — это период между двумя последовательными соединениями Луны и Солнца под одним градусом долготы.

**Формула:**
```
phase_angle = (moon_longitude - sun_longitude) % 360°
moon_age_days = (phase_angle / 360°) × 29.53 дней
lunar_day = floor(moon_age_days) + 1
```

**Важно:** Положение Луны и Солнца вычисляется для конкретного **момента времени UTC**.

---

## Влияние timezone

Наш код вычисляет лунный день на момент **полудня (12:00) по местному времени**:

```python
# backend/services/lunar/engine.py
noon_utc = _local_noon_utc(target_date, tz)  # 12:00 local → UTC
jd_ut = swe.julday(noon_utc.year, noon_utc.month, noon_utc.day, ut)
```

### Пример: 17 декабря 2025

| Локация | Local Noon | UTC Time | Lunar Day |
|---------|-----------|----------|-----------|
| **UTC** | 12:00 | 12:00 UTC | **27** |
| **Москва (UTC+3)** | 12:00 | 09:00 UTC | **26** |
| **Прага (UTC+1)** | 12:00 | 11:00 UTC | **26** |
| **Нью-Йорк (UTC-5)** | 12:00 | 17:00 UTC | **27** |

**Вывод:** Если граница лунного дня проходит между 09:00 и 17:00 UTC, разные timezone покажут **разные дни!**

---

## Почему "два 27-х дня"

При использовании **UTC** как дефолтного timezone:

```
17 декабря, 12:00 UTC → moon_age = 26.5 дней → День 27
18 декабря, 12:00 UTC → moon_age = 27.4 дней → День 27 ← ЕЩЁ 27-й!
19 декабря, 12:00 UTC → moon_age = 28.4 дней → День 28
```

Лунный день 27 "растягивается" на два календарных дня из-за того, что его граница проходит **после полудня UTC**.

При использовании **Europe/Moscow** (UTC+3):

```
17 декабря, 12:00 MSK (09:00 UTC) → moon_age = 25.8 дней → День 26 ✓
18 декабря, 12:00 MSK (09:00 UTC) → moon_age = 26.8 дней → День 27 ✓
19 декабря, 12:00 MSK (09:00 UTC) → moon_age = 27.8 дней → День 28 ✓
```

Теперь каждая дата имеет **уникальный** лунный день!

---

## Что говорят астрологи

В традиционной астрологии и эзотерике:

1. **Лунный день начинается от восхода Солнца** (не от полудня, не от полуночи)
2. **Лунный день может длиться от 19 до 26 часов** (не ровно 24 часа)
3. **Один календарный день может содержать части двух лунных дней**

Пример:
```
17 декабря 2025, Москва:
- 00:00-17:24 → 26-й лунный день
- 17:24-23:59 → 27-й лунный день
```

В этом случае говорят: "17 декабря — день перехода с 26-го на 27-й лунный день".

---

## Наше решение

Для **OneiroScope** (русскоязычный сервис) мы выбрали:

### 1. Референсная локация: Москва (UTC+3)

**Причины:**
- Основная аудитория — русскоязычные пользователи (Россия, Украина, Казахстан)
- Соответствует популярным лунным календарям (lunar-calendar.ru, inastrology.ru)
- Устраняет дублирование дней

**Конфигурация:**
```env
# backend/.env
LUNAR_DEFAULT_TZ=Europe/Moscow

# frontend/.env.local
LUNAR_DEFAULT_TZ=Europe/Moscow
```

### 2. Упрощенный метод: полдень

Мы используем **12:00 по местному времени** как референсную точку для вычисления лунного дня.

**Преимущества:**
- Простота реализации
- Стабильный результат (одна дата = один день)
- Соответствие большинству онлайн-календарей

**Недостатки:**
- Не учитывает, что лунный день может начаться утром или вечером
- Не показывает переходы внутри дня

### 3. Документирование

В UI и документации указываем:
```
Лунный календарь приведен для московского времени (UTC+3)
```

---

## Для точного астрологического расчета

Если требуется **максимальная точность**, нужно:

1. **Вычислять момент начала лунного дня:**
```python
# Найти момент, когда phase_angle = N × 12.175° (360° / 29.53 дней)
# Например, для 27-го дня: phase_angle = 26 × 12.175° = 316.55°
```

2. **Учитывать восход Солнца:**
```python
# Лунный день начинается в момент восхода Солнца,
# когда Луна достигла нужной фазы
```

3. **Показывать переходы:**
```
17 декабря: 26-й день (до 17:24), затем 27-й день
```

Это сложнее и требует дополнительных вычислений.

---

## Сравнение с другими источниками

### Lunar-calendar.ru (для Москвы)
```
17 декабря 2025:
- Лунный день: 27 (26-й день закончился в 17:24)
- Луна в Скорпионе (до 19:55), затем в Стрельце
```

**Они считают:** Если большая часть дня приходится на 27-й лунный день → пишут "27-й день".

**Мы считаем:** На момент полудня (12:00 MSK) → 26-й день.

**Разница:** Метод отсчета (от полудня vs от большей части дня).

### Inastrology.ru
Использует UTC+3 (Москва) и метод "от восхода Солнца".

### Moon Calendar Apps
Большинство mobile apps используют **локальный timezone пользователя**, поэтому результаты могут отличаться.

---

## Рекомендации для пользователей

### Если вы в Москве/Киеве/Алматы:
✅ Используйте `LUNAR_DEFAULT_TZ=Europe/Moscow` (по умолчанию)

### Если вы в Европе (Прага, Берлин):
```env
LUNAR_DEFAULT_TZ=Europe/Prague  # UTC+1
```

### Если вы в США:
```env
LUNAR_DEFAULT_TZ=America/New_York  # UTC-5
```

### Если нужна универсальность:
```env
LUNAR_DEFAULT_TZ=UTC  # Но могут быть дубли дней
```

---

## Выводы

1. **Лунный день ЗАВИСИТ от timezone** — это нормально и правильно
2. **Разные источники могут показывать ±1 день** — из-за метода расчета
3. **Для русскоязычного сервиса оптимально: Europe/Moscow**
4. **Для точных астрологических расчетов** — нужен метод "от восхода Солнца"

---

## Техническая справка

### Текущая реализация

**Файл:** `backend/services/lunar/engine.py`

**Функция:** `compute_lunar(date_iso: str, tz: str) -> LunarResult`

**Алгоритм:**
1. Берет календарную дату (например, "2025-12-17")
2. Конвертирует 12:00 local → UTC
3. Вычисляет JD (Julian Day) для этого момента
4. Получает Sun/Moon longitude от Swiss Ephemeris
5. Вычисляет phase_angle = (moon_lon - sun_lon) % 360
6. Вычисляет lunar_day = floor(phase_angle / 360 × 29.53) + 1

**Точность:**
- Swiss Ephemeris: <1 arc second (астрономическая точность)
- Lunar day: ±1 day depending on timezone and calculation method

### Альтернативные методы

1. **От восхода Солнца (астрологический):**
   - Более сложно
   - Требует вычисления sunrise для каждой даты
   - Может показывать переходы внутри дня

2. **От полуночи (календарный):**
   - Проще
   - Может давать смещение на 12 часов относительно полудня

3. **От новолуния (лунный месяц):**
   - Считает дни от последнего новолуния
   - Требует поиска предыдущего новолуния

**Мы выбрали метод "от полудня"** как баланс между точностью и простотой.

---

**Последнее обновление:** 2025-12-17
**Референсный timezone:** Europe/Moscow (UTC+3)
**Метод расчета:** Local noon (12:00)

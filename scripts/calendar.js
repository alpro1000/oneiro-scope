/* ===== I18N ===== */
const I18N = {
  ru:{brand:"Лунный календарь снов",navDreambook:"Сонник",title:"Лунный календарь снов",subtitle:"Таблица: дата → лунные сутки → тип снов → заметки (оценочно).",thDate:"Дата",thDay:"Лунные сутки",thType:"Тип снов",thNotes:"Краткие пометки",tzLabel:"Часовой пояс:",legend:"Выделено — текущая дата",sources:"Примечание: возраст Луны рассчитывается приближённо по выбранному часовому поясу; типы/заметки — по заданной таблице (оценочно).",footer:"© {year} • Все толкования — оценочно; не медицинский совет.",today:"Сегодня",dbTitle:"Современный сонник",dbSymbol:"Символ",dbSummary:"Кратко",dbConfidence:"Уверенность",dbSearchPlaceholder:"Найдите символ… (например, вода, полёт)",dbFound:"Найдено: {n} символов",dbNoData:"Данные сонника пока не загружены.",interpretTitle:"Разбор сна (оценочно)",interpretIntro:"Вставьте текст сна — покажем связанные символы и краткие пояснения из современного корпуса.",interpretLunar:"Лунные сутки (опц.):",interpretAnalyze:"Разобрать сон",interpretAnalyzing:"Анализ…",interpretNoSymbols:"Символы из словаря не распознаны. Попробуйте описать сон подробнее или уточнить ключевые объекты/действия.",adviceDefault:"Советы: запишите сон сразу после пробуждения; отметьте эмоции/фон сна; сравните со вчерашними событиями."},
  en:{brand:"Lunar Dream Calendar",navDreambook:"Dreambook",title:"Lunar Dream Calendar",subtitle:"Table: date → lunar day → dream type → notes (indicative).",thDate:"Date",thDay:"Lunar day",thType:"Dream type",thNotes:"Notes",tzLabel:"Time zone:",legend:"Highlighted — today",sources:"Note: Moon age is approximated for the selected time zone; dream types/notes come from the provided table.",footer:"© {year} • All interpretations are indicative; not medical advice.",today:"Today",dbTitle:"Modern Dreambook",dbSymbol:"Symbol",dbSummary:"Summary",dbConfidence:"Confidence",dbSearchPlaceholder:"Search a symbol… (e.g., water, flying)",dbFound:"Found: {n} symbols",dbNoData:"Dreambook data not loaded yet.",interpretTitle:"Dream interpretation (indicative)",interpretIntro:"Paste your dream — we’ll surface related symbols and brief explanations from the modern corpus.",interpretLunar:"Lunar day (optional):",interpretAnalyze:"Interpret",interpretAnalyzing:"Analyzing…",interpretNoSymbols:"No dictionary symbols recognized. Try adding more detail or key objects/actions.",adviceDefault:"Tips: write the dream right after waking; note feelings and context; compare with yesterday’s events."},
  de:{brand:"Mondkalender der Träume",navDreambook:"Traumlexikon",title:"Mondkalender der Träume",subtitle:"Tabelle: Datum → Mondtag → Traumtyp → Notizen (indikativ).",thDate:"Datum",thDay:"Mondtag",thType:"Traumtyp",thNotes:"Notizen",tzLabel:"Zeitzone:",legend:"Hervorgehoben — heute",sources:"Hinweis: Mondalter wird näherungsweise für die gewählte Zeitzone berechnet; Typen/Notizen aus der bereitgestellten Tabelle.",footer:"© {year} • Alle Deutungen sind indikativ; keine medizinische Auskunft.",today:"Heute",dbTitle:"Modernes Traumlexikon",dbSymbol:"Symbol",dbSummary:"Kurz",dbConfidence:"Sicherheit",dbSearchPlaceholder:"Symbol suchen… (z. B. Wasser, Fliegen)",dbFound:"Gefunden: {n} Symbole",dbNoData:"Daten des Traumlexikons noch nicht geladen.",interpretTitle:"Traumdeutung (indikativ)",interpretIntro:"Fügen Sie Ihren Traum ein — wir zeigen passende Symbole und kurze Erläuterungen.",interpretLunar:"Mondtag (optional):",interpretAnalyze:"Analysieren",interpretAnalyzing:"Analysiere…",interpretNoSymbols:"Keine Lexikon-Symbole erkannt. Bitte Details/Objekte ergänzen.",adviceDefault:"Tipps: Traum direkt nach dem Aufwachen notieren; Gefühle/Kontext festhalten; mit dem Vortag vergleichen."},
  es:{brand:"Calendario lunar de sueños",navDreambook:"Diccionario de sueños",title:"Calendario lunar de sueños",subtitle:"Tabla: fecha → día lunar → tipo de sueño → notas (indicativo).",thDate:"Fecha",thDay:"Día lunar",thType:"Tipo de sueño",thNotes:"Notas",tzLabel:"Huso horario:",legend:"Resaltado — hoy",sources:"Notas: la edad lunar se estima según el huso; tipos/notas de la tabla proporcionada.",footer:"© {year} • Todas las interpretaciones son indicativas; no constituyen consejo médico.",today:"Hoy",dbTitle:"Diccionario moderno de sueños",dbSymbol:"Símbolo",dbSummary:"Resumen",dbConfidence:"Confianza",dbSearchPlaceholder:"Busca un símbolo… (p. ej., agua, volar)",dbFound:"Encontrados: {n} símbolos",dbNoData:"Datos del diccionario aún no cargados.",interpretTitle:"Interpretación onírica (indicativa)",interpretIntro:"Pega tu sueño — mostraremos símbolos relacionados y breves explicaciones.",interpretLunar:"Día lunar (opcional):",interpretAnalyze:"Interpretar",interpretAnalyzing:"Analizando…",interpretNoSymbols:"No se reconocieron símbolos. Agrega más detalles/objetos.",adviceDefault:"Consejos: escribe el sueño al despertar; registra emociones y contexto; compáralo con el día anterior."},
  it:{brand:"Calendario lunare dei sogni",navDreambook:"Dizionario dei sogni",title:"Calendario lunare dei sogni",subtitle:"Tabella: data → giorno lunare → tipo di sogno → note (indicativo).",thDate:"Data",thDay:"Giorno lunare",thType:"Tipo di sogno",thNotes:"Note",tzLabel:"Fuso orario:",legend:"Evidenziato — oggi",sources:"Nota: l'età della Luna è stimata per il fuso selezionato; i tipi/note provengono dalla tabella fornita.",footer:"© {year} • Tutte le interpretazioni sono indicative; non sono un consiglio medico.",today:"Oggi",dbTitle:"Dizionario moderno dei sogni",dbSymbol:"Simbolo",dbSummary:"Sintesi",dbConfidence:"Fiducia",dbSearchPlaceholder:"Cerca un simbolo… (es. acqua, volo)",dbFound:"Trovati: {n} simboli",dbNoData:"Dati del dizionario non ancora caricati.",interpretTitle:"Interpretazione del sogno (indicativa)",interpretIntro:"Incolla il tuo sogno — mostreremo simboli correlati e brevi spiegazioni.",interpretLunar:"Giorno lunare (opz.):",interpretAnalyze:"Interpreta",interpretAnalyzing:"Analisi…",interpretNoSymbols:"Nessun simbolo riconosciuto. Aggiungi dettagli/oggetti.",adviceDefault:"Suggerimenti: annota il sogno al risveglio; emozioni e contesto; confrontalo con ieri."},
  uk:{brand:"Місячний календар снів",navDreambook:"Сонник",title:"Місячний календар снів",subtitle:"Таблиця: дата → місячна доба → тип сну → нотатки (орієнтовно).",thDate:"Дата",thDay:"Місячна доба",thType:"Тип сну",thNotes:"Нотатки",tzLabel:"Часовий пояс:",legend:"Підсвічено — сьогодні",sources:"Примітка: вік Місяця обчислюється наближено; типи/нотатки — з наданої таблиці.",footer:"© {year} • Усі тлумачення орієнтовні; не є медичною порадою.",today:"Сьогодні",dbTitle:"Сучасний сонник",dbSymbol:"Символ",dbSummary:"Стисло",dbConfidence:"Впевненість",dbSearchPlaceholder:"Знайдіть символ… (наприклад, вода, політ)",dbFound:"Знайдено: {n} символів",dbNoData:"Дані сонника ще не завантажені.",interpretTitle:"Розбір сну (орієнтовно)",interpretIntro:"Вставте текст сну — покажемо дотичні символи та короткі пояснення.",interpretLunar:"Місячна доба (необов’язк.):",interpretAnalyze:"Розібрати",interpretAnalyzing:"Аналіз…",interpretNoSymbols:"Символів не розпізнано. Додайте деталей/об’єктів.",adviceDefault:"Поради: запишіть сон після пробудження; емоції/контекст; порівняйте з учорашнім днем."},
  fr:{brand:"Calendrier lunaire des rêves",navDreambook:"Dictionnaire des rêves",title:"Calendrier lunaire des rêves",subtitle:"Tableau : date → jour lunaire → type de rêve → notes (indicatif).",thDate:"Date",thDay:"Jour lunaire",thType:"Type de rêve",thNotes:"Notes",tzLabel:"Fuseau horaire :",legend:"Surligné — aujourd’hui",sources:"Remarque : l’âge de la Lune est estimé ; types/notes issus du tableau fourni.",footer:"© {year} • Toutes les interprétations sont indicatives ; pas un avis médical.",today:"Aujourd’hui",dbTitle:"Dictionnaire moderne des rêves",dbSymbol:"Symbole",dbSummary:"Résumé",dbConfidence:"Confiance",dbSearchPlaceholder:"Recherchez un symbole… (ex. eau, vol)",dbFound:"Trouvés : {n} symboles",dbNoData:"Données du dictionnaire non encore chargées.",interpretTitle:"Interprétation de rêve (indicative)",interpretIntro:"Collez votre rêve — nous afficherons des symboles liés et de brèves explications.",interpretLunar:"Jour lunaire (optionnel) :",interpretAnalyze:"Interpréter",interpretAnalyzing:"Analyse…",interpretNoSymbols:"Aucun symbole reconnu. Ajoutez des détails/objets.",adviceDefault:"Conseils : écrivez le rêve au réveil ; notez émotions/contexte ; comparez à la veille."}
};

/* ===== Таблицы day,type,notes для всех языков (1..30) ===== */
/* RU */
const TABLE_RU=[null,
  {type:"без фиксированной категории",notes:"Лучшее время формулировать намерения; если снится — трактуйте как ориентир, не как прогноз."},
  {type:"без отдельной метки",notes:"День про щедрость и планирование; спец. категории снов нет."},
  {type:"проверочные; склонные к воплощению",notes:"Преодоление во сне → в жизни проверка/шанс реализации."},
  {type:"предостерегающие; родовые",notes:"Темы семьи/предков; требовательные к вниманию сны."},
  {type:"нейтрально-позитивные",notes:"Благоприятный фон; строгих правил нет."},
  {type:"предвосхищающие; интуитивные",notes:"Хорошо ловятся линии будущего; уединение помогает."},
  {type:"высокоинформативные",notes:"Часто сбываются; фиксируйте детали."},
  {type:"пророческие про призвание",notes:"Намёки на предназначение, долгий курс."},
  {type:"без явной категории",notes:"День напряжённый; спец. правил по снам нет."},
  {type:"в основном «пустые»",notes:"Без сильных признаков информативность низкая; с акцентами — род/семья."},
  {type:"маркер на завтрашние «вещие»",notes:"Сигнал, что 12-е может быть значимым."},
  {type:"светлые и сбывающиеся",notes:"Чистые, доброкачественные сны."},
  {type:"инсайты и указатели",notes:"Озарения; импульс тянется на следующую ночь."},
  {type:"эмоциональная разрядка",notes:"Неприятные сюжеты как выпуск напряжения."},
  {type:"без фиксированной категории",notes:"День с предостережениями; тип снов не задан."},
  {type:"очистительные",notes:"Снимают внутреннее напряжение."},
  {type:"нейтрально-рабочие",notes:"Без спец. ожиданий по снам."},
  {type:"энергетические (не предсказательные)",notes:"Для практик силы/света."},
  {type:"преимущественно неинформативные",notes:"Можно не задерживаться на расшифровке."},
  {type:"без отдельной метки",notes:"Фокус на воле; тип не задан."},
  {type:"восстановительные (на следующую ночь)",notes:"Ночью далее — исцеление без новой инфы."},
  {type:"познавательные; обучающие",notes:"Приносят знания и рабочие подсказки."},
  {type:"инверсионные («наоборот»)",notes:"Трактовка «наоборот» (учитывать контекст)."},
  {type:"диагностические",notes:"Отражают состояние тела/сексуальности."},
  {type:"тишина / минимум сигналов",notes:"Чаще пауза восприятия."},
  {type:"про самооценку",notes:"Зеркалят самооценку и заботу о себе."},
  {type:"интуитивно-пророческие (две ночи)",notes:"Озарения сегодня и завтра."},
  {type:"уравновешенные",notes:"Гармоничный фон; без жёсткой метки."},
  {type:"пограничные; «ритуальные»",notes:"Переходные сюжеты; отдельной классификации нет."},
  {type:"итоговые пророческие",notes:"Много информации; подсвечивают ошибки и рост."}
];
/* EN */
const TABLE_EN=[null,
  {type:"no fixed category",notes:"Best time to set intentions and plans; treat any dream as a compass, not a forecast."},
  {type:"no separate label",notes:"A day of generosity/planning; no specific dream category."},
  {type:"testing; likely to materialize",notes:"Overcoming hurdles in a dream → life will test you; scenario is actionable."},
  {type:"cautionary; ancestral",notes:"Family/ancestors themes; dreams warn of risks and require attentiveness."},
  {type:"neutral-positive",notes:"Favorable backdrop; no strict rules."},
  {type:"anticipatory; intuitive",notes:"Future lines are easier to grasp; solitude sharpens clarity."},
  {type:"highly informative",notes:"Often come true; capture details."},
  {type:"prophetic about vocation",notes:"Hints at calling and long-term direction."},
  {type:"no clear category",notes:"Tense day; no special dream rules."},
  {type:"mostly “empty”",notes:"Without strong markers there’s little meaning; with accents — family/lineage themes."},
  {type:"marker for tomorrow’s ‘prophetic’",notes:"Signal that the 12th may be significant."},
  {type:"bright and fulfilled",notes:"Quiet, clear dreams, often confirmed."},
  {type:"insights and pointers",notes:"Epiphanies; momentum continues into the next night."},
  {type:"emotional discharge",notes:"Unpleasant plots release tension rather than predict events."},
  {type:"no fixed category",notes:"Warnings in the day; no specific dream type."},
  {type:"cleansing",notes:"Helps release inner strain."},
  {type:"neutral, worklike",notes:"No special expectations."},
  {type:"energetic (not predictive)",notes:"Good for power/light practice."},
  {type:"mostly non-informative",notes:"You can skip decoding."},
  {type:"no separate label",notes:"Resolve and will; no set dream type."},
  {type:"restorative (next night)",notes:"Next night brings little info but supports recharge/healing."},
  {type:"knowledge-bearing; instructive",notes:"Brings know-how and practical hints."},
  {type:"inverted (‘opposite’)",notes:"Interpret in reverse (consider context)."},
  {type:"diagnostic",notes:"Reflects state of body/sexual energy."},
  {type:"quiet / minimal signals",notes:"Often a pause and sensory rest."},
  {type:"about self-esteem",notes:"Highlights self-worth, boundaries, self-care."},
  {type:"intuitive-prophetic (two nights)",notes:"Insights today and tomorrow."},
  {type:"balanced",notes:"Harmonious background; no rigid label."},
  {type:"liminal; ‘ritual’",notes:"Transitional motifs; no separate classification."},
  {type:"final prophetic",notes:"Rich in information; show mistakes and growth points."}
];
/* DE */
const TABLE_DE=[null,
  {type:"keine feste Kategorie",notes:"Beste Zeit für Intentionen/Pläne; Träume als Kompass, nicht als Vorhersage."},
  {type:"ohne eigene Kennzeichnung",notes:"Tag der Großzügigkeit/Planung; keine spezielle Traumkategorie."},
  {type:"prüfend; zur Umsetzung neigend",notes:"Hindernisse im Traum überwinden → Bewährungsprobe im Leben; umsetzbar."},
  {type:"warnend; ahnenbezogen",notes:"Familie/Vorfahren; Träume mahnen zur Aufmerksamkeit."},
  {type:"neutral-positiv",notes:"Günstiger Hintergrund; keine strengen Regeln."},
  {type:"vorausschauend; intuitiv",notes:"Zukünftige Linien erfassbar; Einsamkeit erhöht Klarheit."},
  {type:"sehr informativ",notes:"Häufig zutreffend; Details notieren."},
  {type:"prophetisch zur Berufung",notes:"Hinweise auf Berufung/Langfristkurs."},
  {type:"ohne klare Kategorie",notes:"Angespannter Tag; keine Sonderregeln."},
  {type:"meist „leer“",notes:"Ohne starke Marker wenig Gehalt; mit Akzenten — Familie/Abstammung."},
  {type:"Marker für morgen „prophetisch“",notes:"Signal, dass der 12. bedeutsam sein kann."},
  {type:"hell und zutreffend",notes:"Ruhige, klare Träume, oft bestätigt."},
  {type:"Aha-Momente und Hinweise",notes:"Eingebungen; Impuls bis zur nächsten Nacht."},
  {type:"emotionale Entladung",notes:"Unangenehme Szenen = Spannungsabfuhr."},
  {type:"keine feste Kategorie",notes:"Warnungen im Tag; kein spezieller Traumtyp."},
  {type:"reinigend",notes:"Innere Spannung lösen."},
  {type:"neutral-arbeitsam",notes:"Keine besonderen Erwartungen."},
  {type:"energetisch (nicht prädiktiv)",notes:"Für Kraft/Licht-Praxis gut."},
  {type:"überwiegend nicht informativ",notes:"Deutung kann man auslassen."},
  {type:"ohne eigene Kennzeichnung",notes:"Entschlossenheit; kein fester Typ."},
  {type:"regenerativ (nächste Nacht)",notes:"Nächste Nacht wenig Info, aber Erholung/Heilung."},
  {type:"wissensbringend; lehrreich",notes:"Bringt Wissen und praktische Hinweise."},
  {type:"invertiert („umgekehrt“)",notes:"Im Gegenteil deuten (Kontext beachten)."},
  {type:"diagnostisch",notes:"Spiegelt Körper/sexuelle Energie."},
  {type:"Stille / minimale Signale",notes:"Pause, Ruhe der Wahrnehmung."},
  {type:"über Selbstwert",notes:"Selbstwert, Grenzen, Selbstfürsorge."},
  {type:"intuitiv-prophetisch (zwei Nächte)",notes:"Eingebungen heute und morgen."},
  {type:"ausgeglichen",notes:"Harmonischer Hintergrund."},
  {type:"liminal; „rituell“",notes:"Übergangsmotive; keine Extra-Klasse."},
  {type:"abschließend prophetisch",notes:"Informationsreich; Fehler und Wachstumspunkte."}
];
/* ES */
const TABLE_ES=[null,
  {type:"sin categoría fija",notes:"Mejor momento para fijar intenciones y planes; brújula, no pronóstico."},
  {type:"sin etiqueta específica",notes:"Día de generosidad/planificación; sin categoría especial."},
  {type:"de prueba; tienden a cumplirse",notes:"Superar obstáculos en el sueño → prueba en la vida; realizable."},
  {type:"de advertencia; ancestrales",notes:"Familia/ancestros; requieren atención."},
  {type:"neutral-positivo",notes:"Fondo favorable; sin reglas estrictas."},
  {type:"anticipatorios; intuitivos",notes:"Se captan líneas del futuro; la soledad aclara."},
  {type:"muy informativos",notes:"A menudo se cumplen; anota detalles."},
  {type:"proféticos sobre la vocación",notes:"Insinúan vocación y rumbo a largo plazo."},
  {type:"sin categoría clara",notes:"Día tenso; sin reglas especiales."},
  {type:"mayormente «vacíos»",notes:"Sin marcadores fuertes hay poco sentido; con señales — familia/linaje."},
  {type:"marcador para los «proféticos» de mañana",notes:"Señal de que el 12 puede ser significativo."},
  {type:"luminosos y veraces",notes:"Sueños claros y tranquilos, a menudo confirmados."},
  {type:"insights e indicaciones",notes:"El impulso sigue la próxima noche."},
  {type:"descarga emocional",notes:"Escenas desagradables liberan tensión."},
  {type:"sin categoría fija",notes:"Advertencias del día; sin tipo especial."},
  {type:"depurativos",notes:"Ayudan a soltar tensión interna."},
  {type:"neutrales-laborales",notes:"Sin expectativas especiales."},
  {type:"energéticos (no predictivos)",notes:"Para prácticas de fuerza/luz."},
  {type:"principalmente no informativos",notes:"Puedes omitir la interpretación."},
  {type:"sin etiqueta específica",notes:"Determinación; sin tipo definido."},
  {type:"restaurativos (la próxima noche)",notes:"Poca info pero recarga/sanación."},
  {type:"de conocimiento; didácticos",notes:"Aportan saber y pistas prácticas."},
  {type:"invertidos («al revés»)",notes:"Leer al contrario (con contexto)."},
  {type:"diagnósticos",notes:"Reflejan estado del cuerpo/energía sexual."},
  {type:"silencio / señales mínimas",notes:"Pausa y descanso de la percepción."},
  {type:"sobre autoestima",notes:"Valía propia, límites, autocuidado."},
  {type:"intuitivo-proféticos (dos noches)",notes:"Revelaciones hoy y mañana."},
  {type:"equilibrados",notes:"Fondo armonioso; sin etiqueta rígida."},
  {type:"liminales; «rituales»",notes:"Motivos de transición; sin clasificación aparte."},
  {type:"proféticos de cierre",notes:"Ricos en información; muestran errores y crecimiento."}
];
/* IT */
const TABLE_IT=[null,
  {type:"senza categoria fissa",notes:"Momento ideale per fissare intenzioni e piani; bussola, non previsione."},
  {type:"senza etichetta specifica",notes:"Giorno di generosità/pianificazione; nessuna categoria speciale."},
  {type:"di verifica; inclini a realizzarsi",notes:"Superare ostacoli nel sogno → prova nella vita; attuabile."},
  {type:"di avvertimento; legati agli antenati",notes:"Famiglia/antenati; richiedono attenzione."},
  {type:"neutro-positivo",notes:"Sfondo favorevole; niente regole rigide."},
  {type:"anticipatori; intuitivi",notes:"Si colgono linee di futuro; la solitudine chiarisce."},
  {type:"altamente informativi",notes:"Spesso si avverano; annota i dettagli."},
  {type:"profetici sulla vocazione",notes:"Alludono a vocazione e rotta di lungo periodo."},
  {type:"senza categoria chiara",notes:"Giorno teso; nessuna regola speciale."},
  {type:"per lo più «vuoti»",notes:"Senza marcatori forti poco senso; con segni — famiglia/linea."},
  {type:"marcatore per i «profetici» di domani",notes:"Segnale che il 12 può essere significativo."},
  {type:"luminosi e veritieri",notes:"Sogni chiari e sereni, spesso confermati."},
  {type:"intuizioni e indicazioni",notes:"L’impulso continua la notte seguente."},
  {type:"scarico emotivo",notes:"Scene spiacevoli rilasciano tensione."},
  {type:"senza categoria fissa",notes:"Avvertimenti del giorno; nessun tipo speciale."},
  {type:"purificatori",notes:"Sciolgono tensioni interne."},
  {type:"neutri-operosi",notes:"Nessuna aspettativa particolare."},
  {type:"energetici (non predittivi)",notes:"Per pratiche di forza/luce."},
  {type:"prevalentemente non informativi",notes:"Si può tralasciare la lettura."},
  {type:"senza etichetta specifica",notes:"Determinazione; nessun tipo definito."},
  {type:"restorativi (la notte successiva)",notes:"Poca info ma ricarica/guarigione."},
  {type:"portatori di conoscenza; didattici",notes:"Apportano sapere e spunti pratici."},
  {type:"invertiti («al contrario»)",notes:"Si leggono al contrario (col contesto)."},
  {type:"diagnostici",notes:"Riflettono stato del corpo/energia sessuale."},
  {type:"silenzio / segnali minimi",notes:"Pausa e riposo della percezione."},
  {type:"sull'autostima",notes:"Valore di sé, confini, cura di sé."},
  {type:"intuitivi-profetici (due notti)",notes:"Rivelazioni oggi e domani."},
  {type:"equilibrati",notes:"Sfondo armonioso; senza etichetta rigida."},
  {type:"liminali; «rituali»",notes:"Motivi di transizione; nessuna classe separata."},
  {type:"profetici conclusivi",notes:"Ricchi d'informazioni; mostrano errori e crescita."}
];
/* UK */
const TABLE_UK=[null,
  {type:"без фіксованої категорії",notes:"Найкращий час для намірів і планів; сни — компас, не прогноз."},
  {type:"без окремої позначки",notes:"День щедрості/планування; окремої категорії немає."},
  {type:"перевірочні; схильні до втілення",notes:"Подолання перешкод у сні → випробування в житті; здійсненно."},
  {type:"застережні; родові",notes:"Теми сім'ї/предків; потребують уваги."},
  {type:"нейтрально-позитивні",notes:"Сприятливий фон; без жорстких правил."},
  {type:"передбачувальні; інтуїтивні",notes:"Лінії майбутнього вловлюються краще; усамітнення додає ясності."},
  {type:"високоінформативні",notes:"Часто збуваються; фіксуйте деталі."},
  {type:"пророчі про покликання",notes:"Натякають на покликання і довгостроковий курс."},
  {type:"без чіткої категорії",notes:"Напружений день; без спец. правил."},
  {type:"переважно «порожні»",notes:"Без сильних маркерів мало сенсу; з акцентами — родина/рід."},
  {type:"маркер на завтрашні «віщі»",notes:"Сигнал, що 12-го може бути значущою."},
  {type:"світлі й правдиві",notes:"Ясні спокійні сни, часто підтверджуються."},
  {type:"інсайти й підказки",notes:"Осяяння; імпульс триває наступної ночі."},
  {type:"емоційне розвантаження",notes:"Неприємні сюжети — вивільнення напруги."},
  {type:"без фіксованої категорії",notes:"Попередження дня; особливого типу немає."},
  {type:"очисні",notes:"Знімають внутрішню напругу."},
  {type:"нейтрально-робочі",notes:"Без особливих очікувань."},
  {type:"енергетичні (не пророчі)",notes:"Добрі для практик сили/світла."},
  {type:"здебільшого неінформативні",notes:"Можна пропустити тлумачення."},
  {type:"без окремої позначки",notes:"Рішучість; тип не задано."},
  {type:"відновні (наступної ночі)",notes:"Мало інформації, але підзарядка/зцілення."},
  {type:"пізнавальні; навчальні",notes:"Приносять знання і практичні підказки."},
  {type:"інверсійні («навпаки»)",notes:"Тлумачити у зворотному ключі (з контекстом)."},
  {type:"діагностичні",notes:"Відображають стан тіла/сексуальної енергії."},
  {type:"тиша / мінімум сигналів",notes:"Пауза й відпочинок сприйняття."},
  {type:"про самооцінку",notes:"Підсвічують цінність себе, межі, турботу."},
  {type:"інтуїтивно-пророчі (дві ночі)",notes:"Осяяння сьогодні і завтра."},
  {type:"збалансовані",notes:"Гармонійний фон; без жорсткої позначки."},
  {type:"пограничні; «ритуальні»",notes:"Перехідні мотиви; без окремої класифікації."},
  {type:"підсумкові пророчі",notes:"Багато інформації; показують помилки та ріст."}
];
/* FR */
const TABLE_FR=[null,
  {type:"sans catégorie fixe",notes:"Moment idéal pour poser des intentions et des plans ; boussole, pas une prédiction."},
  {type:"sans étiquette dédiée",notes:"Jour de générosité/planification ; pas de catégorie spéciale."},
  {type:"d’épreuve; enclins à se réaliser",notes:"Franchir un obstacle en rêve → épreuve dans la vie ; réalisable."},
  {type:"avertisseurs; lignées familiales",notes:"Famille/ancêtres ; vigilance requise."},
  {type:"neutres-positifs",notes:"Contexte favorable ; pas de règles strictes."},
  {type:"anticipatifs; intuitifs",notes:"Les lignes du futur s’attrapent mieux ; la solitude clarifie."},
  {type:"très informatifs",notes:"Souvent avérés ; notez les détails."},
  {type:"prophétiques sur la vocation",notes:"Suggèrent vocation et cap de long terme."},
  {type:"sans catégorie claire",notes:"Journée tendue ; pas de règles spéciales."},
  {type:"plutôt «vides»",notes:"Sans marqueurs forts, peu de sens ; avec signes — famille/ascendance."},
  {type:"marqueur pour les «prophétiques» de demain",notes:"Signal que le 12 peut être marquant."},
  {type:"lumineux et véridiques",notes:"Rêves clairs et calmes, souvent confirmés."},
  {type:"insights et indications",notes:"L’élan continue la nuit suivante."},
  {type:"décharge émotionnelle",notes:"Rêves désagréables = libération de tension."},
  {type:"sans catégorie fixe",notes:"Avertissements du jour ; pas de type particulier."},
  {type:"purificateurs",notes:"Allègent la tension intérieure."},
  {type:"neutres-productifs",notes:"Sans attentes particulières."},
  {type:"énergétiques (non prédictifs)",notes:"Bon pour pratiques de force/lumière."},
  {type:"majoritairement non informatifs",notes:"On peut se passer d’interprétation."},
  {type:"sans étiquette dédiée",notes:"Détermination ; pas de type défini."},
  {type:"restaurateurs (nuit suivante)",notes:"Peu d’info mais recharge/guérison."},
  {type:"porteurs de savoir; pédagogiques",notes:"Apportent connaissances et pistes pratiques."},
  {type:"inversés («à l’envers»)",notes:"Lecture inverse (contexte)."},
  {type:"diagnostiques",notes:"Reflètent l’état du corps/énergie sexuelle."},
  {type:"silence / signaux minimaux",notes:"Pause et repos de la perception."},
  {type:"sur l’estime de soi",notes:"Valeur personnelle, limites, soin de soi."},
  {type:"intuitifs-prophétiques (deux nuits)",notes:"Illuminations aujourd’hui et demain."},
  {type:"équilibrés",notes:"Contexte harmonieux ; sans étiquette rigide."},
  {type:"liminaires ; «rituels»",notes:"Motifs de transition ; pas de classification séparée."},
  {type:"prophétiques de clôture",notes:"Riches en informations ; montrent erreurs et axes de croissance."}
];

const TABLES={ru:TABLE_RU,en:TABLE_EN,de:TABLE_DE,es:TABLE_ES,it:TABLE_IT,uk:TABLE_UK,fr:TABLE_FR};

/* ===== Timezones ===== */
const TZ_LIST=[
  "Auto (system)","Europe/Prague","Europe/Kyiv","Europe/Moscow","Europe/Warsaw","Europe/Berlin","Europe/Paris","Europe/London","Europe/Madrid","Europe/Rome","Europe/Istanbul","Europe/Athens",
  "Asia/Dubai","Asia/Tbilisi","Asia/Yerevan","Asia/Almaty","Asia/Tashkent","Asia/Novosibirsk","Asia/Kolkata","Asia/Bangkok","Asia/Hong_Kong","Asia/Shanghai","Asia/Tokyo","Asia/Seoul",
  "Australia/Sydney","Pacific/Auckland","Africa/Cairo","Africa/Johannesburg","Africa/Nairobi",
  "America/Sao_Paulo","America/Buenos_Aires","America/Toronto","America/New_York","America/Chicago","America/Denver","America/Los_Angeles","America/Mexico_City","America/Bogota","America/Lima","America/Santiago"
];

/* ===== Astronomy ===== */
const SYNODIC=29.530588853; // days
const REF=Date.UTC(2000,0,6,18,14,0); // reference new moon (UTC)
const B=[1.84566,5.53699,9.22831,12.91963,16.61096,20.30228,23.99361,27.68493];

function offsetISO(tz, baseUTC){
  const parts=new Intl.DateTimeFormat('en-US',{timeZone:tz,hour12:false,year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit'}).formatToParts(baseUTC);
  const m=Object.fromEntries(parts.map(p=>[p.type,p.value]));
  const local=new Date(`${m.year}-${m.month}-${m.day}T${m.hour}:${m.minute}:${m.second}Z`);
  const diffMin=Math.round((local-baseUTC)/60000);
  const sign=diffMin>=0?'+':'-'; const v=Math.abs(diffMin); const hh=String(Math.floor(v/60)).padStart(2,'0'); const mm=String(v%60).padStart(2,'0');
  return `${sign}${hh}:${mm}`;
}
function makeLocalNoonYMD(y,m,d,tz){
  const off=offsetISO(tz, new Date(Date.UTC(y,m-1,d,12,0,0)));
  return new Date(`${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}T12:00:00${off}`);
}
function moonAge(date){ const days=(date.getTime()-REF)/86400000; return ((days%SYNODIC)+SYNODIC)%SYNODIC; }
function lunarDayFromAge(age){ return Math.max(1,Math.min(30,Math.floor(age)+1)); }
function phaseKeyFromAge(age){
  if(age<B[0]||age>=B[7])return "New";
  if(age<B[1])return "WaxingCrescent";
  if(age<B[2])return "FirstQuarter";
  if(age<B[3])return "WaxingGibbous";
  if(age<B[4])return "Full";
  if(age<B[5])return "WaningGibbous";
  if(age<B[6])return "LastQuarter";
  if(age<B[7])return "WaningCrescent";
  return "New";
}

/* ===== Date utils ===== */
function ymd(date, tz){
  const s=new Intl.DateTimeFormat('en-CA',{timeZone:tz,year:'numeric',month:'2-digit',day:'2-digit'}).format(date);
  const [y,m,d]=s.split('-').map(Number); return {y,m,d};
}
function ymOf(date, tz){
  const p=new Intl.DateTimeFormat('en-CA',{timeZone:tz,year:'numeric',month:'2-digit',day:'2-digit'}).formatToParts(date);
  const map=Object.fromEntries(p.map(x=>[x.type,x.value])); return {y:+map.year,m:+map.month};
}
function daysInMonth(y,m){ return new Date(Date.UTC(y,m,0)).getUTCDate(); }
function fmtDate(d, tz, lang){ return new Intl.DateTimeFormat(lang,{timeZone:tz,day:"numeric",month:"long"}).format(d); }

/* ===== UI state ===== */
const $=id=>document.getElementById(id);
const langSel=$("lang"), tzSel=$("tz"), monthLabel=$("monthLabel"), calendarTbody=$("tbody");
const prevBtn=$("prev"), nextBtn=$("next"), todayBtn=$("today"), navDreambookBtn=$("navDreambook");
const SUPPORTED=["ru","en","de","es","it","uk","fr"];
const sysLang=(navigator.language||"ru").slice(0,2).toLowerCase();
let lang=SUPPORTED.includes(sysLang)?sysLang:"ru";
let tz=Intl.DateTimeFormat().resolvedOptions().timeZone||"Europe/Prague";
let navDate=new Date();

function fillLang(){
  const names={ru:"Русский",en:"English",de:"Deutsch",es:"Español",it:"Italiano",uk:"Українська",fr:"Français"};
  SUPPORTED.forEach(code=>{const o=document.createElement("option");o.value=code;o.textContent=names[code];langSel.appendChild(o);});
  langSel.value=lang;
}
function fillTZ(){
  TZ_LIST.forEach(z=>{const o=document.createElement("option");o.value=z;o.textContent=z;tzSel.appendChild(o);});
  tzSel.value=tzSel.querySelector(`option[value="${tz}"]`)?tz:"Auto (system)";
  $("tzActive").textContent=tzSel.value==="Auto (system)"?tz:tzSel.value;
}
function t(){ return I18N[lang] || I18N.ru; }
function applyI18N(){
  const L=t();
  $("brandName").textContent=L.brand;
  navDreambookBtn.textContent=L.navDreambook;
  $("title").textContent=L.title; $("subtitle").textContent=L.subtitle;
  $("thDate").textContent=L.thDate; $("thDay").textContent=L.thDay; $("thType").textContent=L.thType; $("thNotes").textContent=L.thNotes;
  $("tzLabel").textContent=L.tzLabel; $("legend").textContent=L.legend; $("sources").textContent=L.sources;
  $("footerText").innerHTML=L.footer.replace("{year}",new Date().getFullYear());
  document.documentElement.lang=lang;
  todayBtn.textContent=L.today;

  // «Разбор сна»
  const it = document.getElementById("interpret");
  if (it){
    const h2 = $("interpretTitle"); if (h2) h2.textContent = L.interpretTitle;
    const p = $("interpretIntro"); if (p) p.textContent = L.interpretIntro;
    const lbl = $("lunarLabel"); if (lbl) lbl.textContent = L.interpretLunar;
    const btn = $("analyzeBtn"); if (btn) btn.textContent = L.interpretAnalyze;
  }

  // Сонник
  const ds=$("dreamSearch"); if (ds) ds.placeholder=L.dbSearchPlaceholder;
  const dbTitle=$("dbTitle"); if (dbTitle) dbTitle.textContent=L.dbTitle;
  const thS=$("dbThSymbol"); if (thS) thS.textContent=L.dbSymbol;
  const thSm=$("dbThSummary"); if (thSm) thSm.textContent=L.dbSummary;
  const thC=$("dbThConf"); if (thC) thC.textContent=L.dbConfidence;
}

/* ===== SVG-луна: динамическая фаза ===== */
function updateMoonIcon(uiTZ){
  const n=new Date();
  const noon=makeLocalNoonYMD(...Object.values(ymd(n,uiTZ)), uiTZ);
  const age=moonAge(noon);
  const phaseFrac=age/SYNODIC; // 0..1
  // cos-модель сдвига тени (простая эвристика)
  const k=Math.cos(2*Math.PI*phaseFrac); // 1=new, -1=full
  const cx=50 + k*50; // смещаем тень по оси X
  const shadow=document.getElementById("shadowCircle");
  if(shadow){ shadow.setAttribute("cx", String(cx)); }

  const key=phaseKeyFromAge(age);
  const phaseNames={
    ru:{New:"Новолуние",WaxingCrescent:"Растущий серп",FirstQuarter:"Первая четверть",WaxingGibbous:"Растущая выпуклая",Full:"Полнолуние",WaningGibbous:"Убывающая выпуклая",LastQuarter:"Последняя четверть",WaningCrescent:"Убывающий серп"},
    en:{New:"New Moon",WaxingCrescent:"Waxing Crescent",FirstQuarter:"First Quarter",WaxingGibbous:"Waxing Gibbous",Full:"Full Moon",WaningGibbous:"Waning Gibbous",LastQuarter:"Last Quarter",WaningCrescent:"Waning Crescent"}
  };
  const name=(phaseNames[lang]||phaseNames.ru)[key];
  const nice=fmtDate(noon,uiTZ,lang)+" "+new Intl.DateTimeFormat(lang,{timeZone:uiTZ,year:"numeric"}).format(noon);
  const svg=document.getElementById("moonSvg");
  svg?.setAttribute("role","img");
  svg?.setAttribute("aria-label",`${name} • ${nice}`);
  svg?.setAttribute("title",`${name} • ${nice}`);
}

/* ===== Render month ===== */
function renderMonth(){
  const uiTZ = tzSel.value==="Auto (system)" ? tz : tzSel.value;
  $("tzActive").textContent=uiTZ;

  const {y:vy,m:vm}=ymOf(navDate, uiTZ);
  monthLabel.textContent=new Intl.DateTimeFormat(lang,{timeZone:uiTZ,month:"long",year:"numeric"}).format(makeLocalNoonYMD(vy,vm,1,uiTZ));

  const table=TABLES[lang]||TABLES.ru;
  const today=ymd(new Date(), uiTZ);

  calendarTbody.innerHTML="";
  const total=daysInMonth(vy,vm);
  for(let d=1; d<=total; d++){
    const localNoon=makeLocalNoonYMD(vy,vm,d,uiTZ);
    const lday=lunarDayFromAge(moonAge(localNoon));
    const row=table[lday];

    const tr=document.createElement("tr");
    const rowYMD=ymd(localNoon, uiTZ);
    if(rowYMD.y===today.y && rowYMD.m===today.m && rowYMD.d===today.d){
      tr.classList.add("today");
      tr.setAttribute("aria-current","date");
    }

    const tdDate=document.createElement("td"); tdDate.className="dateCell"; tdDate.textContent=fmtDate(localNoon,uiTZ,lang);
    const tdDay=document.createElement("td"); tdDay.className="dayCell"; tdDay.textContent=String(lday);
    const tdType=document.createElement("td"); tdType.className="typeCell"; tdType.textContent=row.type;
    const tdNotes=document.createElement("td"); tdNotes.className="notesCell"; tdNotes.textContent=row.notes;

    tr.append(tdDate,tdDay,tdType,tdNotes); calendarTbody.appendChild(tr);
  }
  updateMoonIcon(uiTZ);
}

/* ===== Events & init ===== */
const yearEl=document.getElementById('year');
function init(){
  // заполняем языки/таймзоны
  fillLang(); fillTZ(); applyI18N();
  if(yearEl) yearEl.textContent=new Date().getFullYear();

  // рендерим календарь
  renderMonth();

  // селект 1..30 для «Разбор сна»
  const lunarSel = document.getElementById('lunarHint');
  if (lunarSel){
    lunarSel.innerHTML="";
    const optNone = document.createElement('option'); optNone.value=""; optNone.textContent="—"; lunarSel.appendChild(optNone);
    for(let i=1;i<=30;i++){ const o=document.createElement('option'); o.value=String(i); o.textContent=String(i); lunarSel.appendChild(o); }
  }

  // слушатели
  langSel.addEventListener("change",()=>{ lang=langSel.value; applyI18N(); renderMonth(); if(window.renderDreambookCount) renderDreambookCount(); });
  tzSel.addEventListener("change",()=>{ if(tzSel.value==="Auto (system)"){$("tzActive").textContent=tz;} renderMonth(); });
  prevBtn.addEventListener("click",()=>{ const uiTZ=tzSel.value==="Auto (system)"?tz:tzSel.value; const {y,m}=ymOf(navDate,uiTZ); navDate=makeLocalNoonYMD(m===1?y-1:y, m===1?12:m-1, 15, uiTZ); renderMonth(); });
  nextBtn.addEventListener("click",()=>{ const uiTZ=tzSel.value==="Auto (system)"?tz:tzSel.value; const {y,m}=ymOf(navDate,uiTZ); navDate=makeLocalNoonYMD(m===12?y+1:y, m===12?1:m+1, 15, uiTZ); renderMonth(); });
  todayBtn.addEventListener("click",()=>{ navDate=new Date(); renderMonth(); });
}
init();

